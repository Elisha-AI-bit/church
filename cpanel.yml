---
deployment:
  tasks:
    # Set paths
    - export DEPLOYPATH=/home/uczsilve/repositories/church
    - export PUBLIC_HTML=/home/uczsilve/public_html

    # Copy project files to public_html
    - /bin/cp -R $DEPLOYPATH/* $PUBLIC_HTML/

    # Activate virtual environment or create it if missing
    - if [ ! -d /home/uczsilve/venv ]; then python3 -m venv /home/uczsilve/venv; fi
    - source /home/uczsilve/venv/bin/activate

    # Upgrade pip and install dependencies
    - pip install --upgrade pip
    - pip install -r $PUBLIC_HTML/requirements.txt

    # Apply database migrations
    - python $PUBLIC_HTML/manage.py migrate

    # Collect static files into public_html/static
    - python $PUBLIC_HTML/manage.py collectstatic --noinput

    # Reload Passenger to pick up changes
    - touch $PUBLIC_HTML/passenger_wsgi.py
