{% extends 'base.html' %}

{% block page_title %}Church Workers{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow">
        <h2 class="text-xl font-bold text-gray-800">Worker Management</h2>
        <button onclick="openModal()"
            class="bg-ucz-blue hover:bg-blue-800 text-white px-4 py-2 rounded-lg transition duration-200">
            <i class="fas fa-plus mr-2"></i> Add Worker
        </button>
    </div>

    <!-- Workers Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NRC</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status
                    </th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Basic
                        Salary</th>
                    <!-- <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th> -->
                </tr>
            </thead>
            <tbody id="employeeTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>
</div>

<!-- Add Employee Modal -->
<div id="employeeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">Add New Worker</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        <form id="employeeForm" onsubmit="saveEmployee(event)" class="space-y-4">
            <!-- Step 1: Personal Information -->
            <div id="step1" class="step-content">
                <h4 class="text-sm font-bold text-gray-800 mb-4 pb-2 border-b">Step 1: Personal Information</h4>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">First Name <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="firstName" name="first_name" required
                                class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Last Name <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="lastName" name="last_name" required
                                class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Role/Position</label>
                            <input type="text" name="role" required
                                class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Gender</label>
                            <select name="gender" class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">NRC Number</label>
                        <input type="text" name="nrc_number" placeholder="123456/10/1"
                            class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Residential Address</label>
                        <textarea name="address" rows="2"
                            class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                            <input type="text" name="phone" class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" name="email" class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Date Joined</label>
                            <input type="date" name="date_joined" required
                                class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="col-span-2">
                            <!-- Placeholder for step 1 end -->
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-50">Cancel</button>
                    <button type="button" onclick="goToStep(2)"
                        class="px-4 py-2 bg-ucz-blue text-white rounded hover:bg-blue-800">Next: Finance &rarr;</button>
                </div>
            </div>

            <!-- Step 2: Financial Details -->
            <div id="step2" class="step-content hidden">
                <h4 class="text-sm font-bold text-blue-800 mb-4 pb-2 border-b border-blue-200">Step 2: Compensation &
                    Finance</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Basic Salary (ZMW) <span
                                class="text-red-500">*</span></label>
                        <input type="number" name="basic_salary" step="0.01" required
                            class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-2 uppercase">Allowances
                            (Monthly)</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600">Housing</label>
                                <input type="number" name="housing_allowance" step="0.01" value="0"
                                    class="mt-1 w-full border-gray-300 rounded-md shadow-sm text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600">Transport</label>
                                <input type="number" name="transport_allowance" step="0.01" value="0"
                                    class="mt-1 w-full border-gray-300 rounded-md shadow-sm text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600">Education</label>
                                <input type="number" name="education_allowance" step="0.01" value="0"
                                    class="mt-1 w-full border-gray-300 rounded-md shadow-sm text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600">Medical</label>
                                <input type="number" name="medical_allowance" step="0.01" value="0"
                                    class="mt-1 w-full border-gray-300 rounded-md shadow-sm text-sm">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between space-x-3 mt-6">
                    <button type="button" onclick="goToStep(1)"
                        class="px-4 py-2 text-gray-600 hover:text-gray-900 border rounded">&larr; Back</button>
                    <div class="flex space-x-2">
                        <button type="button" onclick="closeModal()"
                            class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save
                            Worker</button>
                    </div>
                </div>
            </div>


        </form>
    </div>
</div>

<script>
    async function loadEmployees() {
        try {
            const response = await fetch('/api/hr/employees/');
            const data = await response.json();
            const employees = data.results ? data.results : data;

            const tbody = document.getElementById('employeeTableBody');
            tbody.innerHTML = employees.map(emp => `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="h-8 w-8 rounded-full bg-ucz-blue/10 flex items-center justify-center text-ucz-blue font-bold text-xs mr-3">
                            ${emp.first_name[0]}${emp.last_name[0]}
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">${emp.first_name} ${emp.last_name}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${emp.role}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${emp.nrc_number || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${emp.gender || '-'}</td>
                <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" title="${emp.address}">
                    ${emp.address || '-'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div>${emp.phone || ''}</div>
                    <div class="text-xs">${emp.email || ''}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                        ${emp.status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium text-gray-900">
                    ${formatCurrency(emp.basic_salary)}
                </td>
            </tr>
        `).join('');
        } catch (e) {
            console.error("Failed to load employees", e);
        }
    }

    async function saveEmployee(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        // Helper to get CSRF token
        const getCookie = (name) => {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        try {
            // Sanitize data
            if (data.email === '') delete data.email;
            if (data.phone === '') delete data.phone;

            const response = await fetch('/api/hr/employees/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal();
                loadEmployees();
                e.target.reset();
            } else {
                const errorData = await response.json();
                console.error('Save Error:', errorData);
                alert(`Failed to save: ${JSON.stringify(errorData)}`);
            }
        } catch (err) {
            console.error(err);
            alert('Error saving employee');
        }
    }

    function goToStep(step) {
        // Validate Step 1 before moving
        if (step === 2) {
            const fName = document.getElementById('firstName').value;
            const lName = document.getElementById('lastName').value;
            const role = document.getElementById('role').value;
            if (!fName || !lName || !role) {
                alert('Please fill in Name and Role first.');
                return;
            }
        }

        // Hide all steps
        document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
        // Show target step
        document.getElementById(`step${step}`).classList.remove('hidden');
    }

    function openModal() {
        document.getElementById('employeeModal').classList.remove('hidden');
        goToStep(1); // Always start at 1
    }

    function closeModal() {
        document.getElementById('employeeModal').classList.add('hidden');
    }

    function formatCurrency(val) {
        return new Intl.NumberFormat('en-ZM', { style: 'currency', currency: 'ZMW' }).format(val);
    }

    // Initial Load
    loadEmployees();
</script>
{% endblock %}